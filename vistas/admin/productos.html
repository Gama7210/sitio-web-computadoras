<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionar Productos - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="neumorphic-body">

  <nav class="navbar neumorphic-nav">
    <div class="container">
      <a class="navbar-brand" href="/vistas/admin/dashboard.html">Panel Admin</a>
      <a href="/" class="ms-auto">Volver al sitio</a>
    </div>
  </nav>

  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="neumorphic-title">Gestión de Productos</h2>
      <button class="neumorphic-btn" id="btnNuevoProducto" data-bs-toggle="modal" data-bs-target="#addProductModal">
        + Nuevo Producto
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-dark table-hover" id="productos-table">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Marca</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="productos-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Agregar / Editar -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content neumorphic-card">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Nuevo Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="productForm">
            <input type="hidden" id="productId">

            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Nombre del Producto *</label>
                <input type="text" id="nombre" class="neumorphic-input w-100" required>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <label class="form-label">Categoría *</label>
                <input type="text" id="categoria" class="neumorphic-input w-100" placeholder="Laptops / Periféricos / Monitores / Sillas" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Marca *</label>
                <input type="text" id="marca" class="neumorphic-input w-100" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Modelo *</label>
                <input type="text" id="modelo" class="neumorphic-input w-100" required>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <label class="form-label">Precio ($) *</label>
                <input type="number" id="precio" class="neumorphic-input w-100" required min="1" step="0.01">
              </div>
              <div class="col-md-4">
                <label class="form-label">Stock *</label>
                <input type="number" id="stock" class="neumorphic-input w-100" required min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">URL Imagen (opcional)</label>
                <input type="url" id="imagen" class="neumorphic-input w-100" placeholder="https://...">
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <label class="form-label">RAM (opcional)</label>
                <input type="text" id="ram" class="neumorphic-input w-100" placeholder="16GB DDR5">
              </div>
              <div class="col-md-4">
                <label class="form-label">Almacenamiento (opcional)</label>
                <input type="text" id="almacenamiento" class="neumorphic-input w-100" placeholder="512GB SSD">
              </div>
              <div class="col-md-4">
                <label class="form-label">Procesador (opcional)</label>
                <input type="text" id="procesador" class="neumorphic-input w-100" placeholder="Intel i7-13650HX">
              </div>
            </div>

            <div class="mt-3">
              <img id="imagePreview" class="img-fluid rounded mx-auto d-block" style="max-height: 200px; display:none;" src="">
            </div>

            <div class="mt-3">
              <label class="form-label">Descripción (opcional)</label>
              <textarea id="descripcion" class="neumorphic-input w-100" rows="3"></textarea>
            </div>

            <button type="submit" class="neumorphic-btn w-100 mt-4" id="saveButton">Guardar Producto</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    let editId = null;

    // Preview de imagen al escribir URL
    document.getElementById('imagen').addEventListener('input', function(e) {
      const preview = document.getElementById('imagePreview');
      const url = e.target.value.trim();
      preview.src = url;
      preview.style.display = url ? 'block' : 'none';
    });

    // Cargar productos
    async function cargarProductos() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Sesión expirada');
        window.location.href = '/vistas/cliente/login-admin.html';
        return;
      }

      try {
        const res = await fetch('/api/admin/productos', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(await res.text());

        const productos = await res.json();
        const tbody = document.getElementById('productos-body');
        tbody.innerHTML = '';

        productos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><img src="${p.imagen || 'https://via.placeholder.com/60'}" width="60" style="border-radius:8px;"></td>
            <td>${p.nombre}</td>
            <td>${p.marca || '-'}</td>
            <td>$${p.precio.toLocaleString()}</td>
            <td>${p.stock}</td>
            <td><span class="badge ${p.activo ? 'bg-success' : 'bg-secondary'}">${p.activo ? 'Activo' : 'Inactivo'}</span></td>
            <td>
              <button class="btn btn-sm btn-warning me-1" onclick="editarProducto('${p._id}')">Editar</button>
              <button class="btn btn-sm btn-danger me-1" onclick="eliminarProducto('${p._id}')">Eliminar</button>
              <button class="btn btn-sm ${p.activo ? 'btn-secondary' : 'btn-success'}" onclick="toggleActivo('${p._id}', ${!p.activo})">
                ${p.activo ? 'Inactivar' : 'Activar'}
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('Error al cargar productos: ' + err.message);
      }
    }

    // Limpiar y abrir modal para nuevo producto
    document.getElementById('btnNuevoProducto').addEventListener('click', () => {
      editId = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Producto';
      document.getElementById('saveButton').textContent = 'Guardar Producto';
      document.getElementById('productForm').reset();
      document.getElementById('imagePreview').style.display = 'none';
    });

    // Editar producto (cargar datos desde la tabla)
    function editarProducto(id) {
      editId = id;
      document.getElementById('modalTitle').textContent = 'Editar Producto';
      document.getElementById('saveButton').textContent = 'Actualizar Producto';

      const row = Array.from(document.querySelectorAll('#productos-body tr')).find(r => r.innerHTML.includes(`editarProducto('${id}')`));
      if (row) {
        document.getElementById('nombre').value = row.cells[1].textContent.trim();
        document.getElementById('marca').value = row.cells[2].textContent.trim();
        document.getElementById('precio').value = parseFloat(row.cells[3].textContent.replace('$', '').replace(',', ''));
        document.getElementById('stock').value = parseInt(row.cells[4].textContent.trim());
      }

      bootstrap.Modal.getOrCreateInstance(document.getElementById('addProductModal')).show();
    }

    // Guardar producto
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) return alert('Sesión expirada');

      const data = {
        nombre: document.getElementById('nombre').value.trim(),
        categoria: document.getElementById('categoria').value.trim(),
        marca: document.getElementById('marca').value.trim(),
        modelo: document.getElementById('modelo').value.trim(),
        precio: parseFloat(document.getElementById('precio').value) || 0,
        stock: parseInt(document.getElementById('stock').value) || 0,
        imagen: document.getElementById('imagen').value.trim(),
        descripcion: document.getElementById('descripcion').value.trim(),
        ram: document.getElementById('ram')?.value.trim() || '',
        almacenamiento: document.getElementById('almacenamiento')?.value.trim() || '',
        procesador: document.getElementById('procesador')?.value.trim() || ''
      };

      if (!data.nombre || !data.categoria || !data.marca || !data.modelo || !data.precio || !data.stock) {
        alert('Faltan campos obligatorios: Nombre, Categoría, Marca, Modelo, Precio y Stock');
        return;
      }

      const method = editId ? 'PUT' : 'POST';
      const url = editId ? `/api/admin/productos/${editId}` : '/api/admin/productos';

      try {
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        const response = await res.json();

        if (res.ok) {
          alert(editId ? 'Producto actualizado con éxito' : 'Producto agregado con éxito');
          bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
          document.getElementById('productForm').reset();
          document.getElementById('imagePreview').style.display = 'none';
          editId = null;
          cargarProductos();
        } else {
          alert(response.msg || 'Error al guardar el producto');
        }
      } catch (err) {
        alert('Error de conexión: ' + err.message);
        console.error(err);
      }
    });

    // Eliminar producto
    async function eliminarProducto(id) {
      if (!confirm('¿Eliminar este producto permanentemente?')) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/admin/productos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          alert('Producto eliminado');
          cargarProductos();
        } else {
          alert('Error al eliminar');
        }
      } catch (err) {
        alert('Error de conexión');
      }
    }

    // Inactivar / Activar
    async function toggleActivo(id, activo) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/admin/productos/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ activo })
        });
        if (res.ok) {
          cargarProductos();
        } else {
          alert('Error al cambiar estado');
        }
      } catch (err) {
        alert('Error de conexión');
      }
    }

    window.onload = cargarProductos;
  </script>
</body>
</html>
