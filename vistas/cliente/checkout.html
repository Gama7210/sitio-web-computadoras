<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finalizar Compra - TechNova</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="neumorphic-body">

  <nav class="navbar neumorphic-nav">
    <div class="container">
      <a class="navbar-brand neumorphic-title" href="/vistas/cliente/catalogo.html">TechNova</a>
      <div class="ms-auto">
        <span id="welcomeUser" class="nav-link text-neon-cyan">Bienvenido, <strong id="userName"></strong></span>
      </div>
    </div>
  </nav>

  <div class="container py-5">
    <h2 class="text-center mb-5 neumorphic-title">Finalizar Compra</h2>

    <div class="row g-5">
      <!-- Formulario de datos -->
      <div class="col-lg-7">
        <div class="neumorphic-card p-4">
          <h4 class="mb-4">Completa tus datos para finalizar la compra</h4>

          <form id="checkoutForm">
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label">Nombre completo</label>
                <input type="text" id="nombre" class="neumorphic-input w-100" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Correo</label>
                <input type="email" id="email" class="neumorphic-input w-100" required>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label">Teléfono</label>
              <input type="tel" id="telefono" class="neumorphic-input w-100" required>
            </div>

            <div class="mb-4">
              <label class="form-label">Dirección completa</label>
              <textarea id="direccion" class="neumorphic-input w-100" rows="3" required placeholder="Calle, número, colonia, ciudad, estado, CP"></textarea>
            </div>

            <h5 class="mb-4">Método de pago (demo segura)</h5>
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label">Nombre en la tarjeta</label>
                <input type="text" class="neumorphic-input w-100" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Número de tarjeta</label>
                <input type="text" class="neumorphic-input w-100" placeholder="•••• •••• •••• ••••" required>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label">Expiración (MM/YY)</label>
                <input type="text" class="neumorphic-input w-100" placeholder="MM/YY" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">CVV</label>
                <input type="text" class="neumorphic-input w-100" placeholder="•••" required>
              </div>
            </div>

            <div class="d-flex gap-3">
              <button type="submit" class="neumorphic-btn btn-lg flex-grow-1">Pagar Ahora</button>
              <a href="/vistas/cliente/carrito.html" class="neumorphic-btn btn-outline btn-lg">Cancelar</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Resumen del carrito -->
      <div class="col-lg-5">
        <div class="neumorphic-card p-4 sticky-top" style="top: 20px;">
          <h4 class="mb-4">Resumen</h4>
          <div id="resumen-carrito"></div>
          <hr>
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <span id="subtotal">$0.00</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Envío</span>
            <span>$0.00</span>
          </div>
          <div class="d-flex justify-content-between fs-5 fw-bold">
            <span>Total</span>
            <span id="total">$0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Pre-llenar datos
  const nombre = localStorage.getItem('nombre') || '';
  const email = localStorage.getItem('email') || '';
  document.getElementById('nombre').value = nombre;
  document.getElementById('email').value = email;
  document.getElementById('userName').textContent = nombre;

  // Cargar resumen
  function cargarResumen() {
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    const container = document.getElementById('resumen-carrito');
    container.innerHTML = '';
    let subtotal = 0;

    carrito.forEach(item => {
      subtotal += item.precio * item.cantidad;
      container.innerHTML += `
        <div class="d-flex justify-content-between mb-2">
          <span>${item.nombre} x ${item.cantidad}</span>
          <span>$${(item.precio * item.cantidad).toLocaleString()}</span>
        </div>
      `;
    });

    document.getElementById('subtotal').textContent = `$${subtotal.toLocaleString()}`;
    document.getElementById('total').textContent = `$${subtotal.toLocaleString()}`;
    return subtotal;
  }

  cargarResumen();

  // Finalizar compra → guardar en BD + PDF
  document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    if (carrito.length === 0) return alert('El carrito está vacío');

    const token = localStorage.getItem('token');
    if (!token) return alert('Sesión expirada, inicia sesión');

    const datos = {
      productos: carrito.map(item => ({
        producto: item.id,
        cantidad: item.cantidad
      })),
      total: cargarResumen(),
      direccion: document.getElementById('direccion').value,
      telefono: document.getElementById('telefono').value
    };

    try {
      const res = await fetch('/api/cliente/pedido', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(datos)
      });

      if (!res.ok) throw new Error('Error al crear pedido');

      // Animación + PDF
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
      alert('¡Compra realizada con éxito! Generando ticket...');

      const pedido = await res.json();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.text('Ticket TechNova #' + pedido._id, 105, 20, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 40);
      doc.text(`Cliente: ${nombre}`, 20, 50);
      doc.text(`Email: ${email}`, 20, 60);
      doc.text(`Dirección: ${datos.direccion}`, 20, 70);
      doc.text(`Teléfono: ${datos.telefono}`, 20, 80);
      doc.text('Productos:', 20, 100);
      let y = 110;
      carrito.forEach(p => {
        doc.text(`${p.nombre} x ${p.cantidad} - $${(p.precio * p.cantidad).toLocaleString()}`, 30, y);
        y += 10;
      });
      doc.setFontSize(16);
      doc.text(`Total: $${datos.total.toLocaleString()}`, 20, y + 10);
      doc.save(`ticket-${pedido._id}.pdf`);

      localStorage.removeItem('carrito');
      window.location.href = '/vistas/cliente/mis-pedidos.html';
    } catch (err) {
      alert('Error al procesar la compra');
    }
  });
</script>
</body>
</html>